
---

### 51. 脚本引擎集成 (V8 Script Integration)

Yao 的核心能力在于 V8 脚本处理。TUI 组件不仅要能调用 Process，还要能支持前端逻辑（虽然是在服务端运行的 TUI，但概念上类似前端逻辑）。

#### 事件回调桥接

当 DSL 中定义了 `onClick: "scripts.user.OnSubmit"` 时：

```go
// framework/bridge/script.go

type ScriptContext struct {
    runtime *v8go.Context
    // ...
}

// Invoke 执行脚本函数
func (sc *ScriptContext) Invoke(scriptPath string, methodName string, args ...interface{}) (interface{}, error) {
    // 1. 加载脚本
    // 2. 注入全局对象 (如 $this, $ui)
    // 3. 执行函数
}

// 注入给 JS 的 UI 操作 API
// 在 JS 中: $ui.toast.success("Saved!")
func (sc *ScriptContext) InjectAPI() {
    uiObj := v8go.NewObjectTemplate(sc.iso)
    uiObj.Set("toast", func(info *v8go.FunctionCallbackInfo) *v8go.Value {
        // 调用 Go 的 ToastManager
        msg := info.Args()[0].String()
        theme.GetToastManager().Success(msg)
        return nil
    })
    // ... Set global "ui"
}

```

#### JavaScript 侧写法示例

```javascript
// scripts/user.js

/**
 * 按钮点击处理
 * @param {object} context - 组件上下文
 * @param {object} args - 事件参数
 */
function OnSubmit(context, args) {
    var data = context.form.getData();
    if (data.age < 18) {
        $ui.toast.error("必须年满18岁");
        $ui.input("age").focus(); // 聚焦到组件
        return;
    }
    
    var id = Process("models.user.Save", data);
    $ui.route.push("/user/detail", {id: id});
}

```